#!/bin/bash

# General purpose devcontainer utility script
# Provides various operations for managing development containers

set -e

# Exit codes
EXIT_SUCCESS=0
EXIT_INVALID_ARGS=1
EXIT_DEP_NOT_FOUND=2
EXIT_DOCKER_ERROR=3
EXIT_DEVCONTAINER_ERROR=4
EXIT_PERMISSION_ERROR=5
EXIT_CONFIG_ERROR=6

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Error handling functions
error_exit() {
    echo -e "${RED}âŒ Error: $1${NC}" >&2
    exit "${2:-$EXIT_INVALID_ARGS}"
}

warning() {
    echo -e "${YELLOW}âš ï¸  Warning: $1${NC}" >&2
}

success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# Input validation functions
validate_command() {
    local cmd="$1"
    local valid_commands="up down enter build clean status logs run init install-opencode help completion"
    
    if [[ ! " $valid_commands " =~ " $cmd " ]]; then
        error_exit "Invalid command '$cmd'. Use 'dcutil help' for available commands." $EXIT_INVALID_ARGS
    fi
}

validate_project_path() {
    local path="$1"
    
    if [ -n "$path" ]; then
        if [ ! -d "$path" ]; then
            error_exit "Project path '$path' does not exist or is not a directory." $EXIT_INVALID_ARGS
        fi
        
        if [ ! -r "$path" ]; then
            error_exit "Cannot read project path '$path'. Permission denied." $EXIT_PERMISSION_ERROR
        fi
        
        # Convert to absolute path
        if ! cd "$path" 2>/dev/null; then
            error_exit "Cannot access project path '$path'." $EXIT_PERMISSION_ERROR
        fi
        PROJECT_DIR="$(pwd)"
        cd - >/dev/null
    fi
}

validate_run_command() {
    if [ $# -eq 0 ]; then
        error_exit "run command requires a command to execute. Usage: dcutil run [project_path] <command>" $EXIT_INVALID_ARGS
    fi
}

validate_init_mode() {
    local mode="$1"
    local valid_modes="fast wizard --fast --wizard --help -h"
    
    if [ -n "$mode" ] && [[ ! " $valid_modes " =~ " $mode " ]]; then
        error_exit "Unknown init mode: '$mode'. Use 'dcutil init --help' for usage information." $EXIT_INVALID_ARGS
    fi
}

# Dependency checking functions
check_devcontainer_cli() {
    if ! command -v devcontainer &> /dev/null; then
        error_exit "devcontainer CLI not found. Please install it first:\n   npm install -g @devcontainers/cli" $EXIT_DEP_NOT_FOUND
    fi
}

check_docker_daemon() {
    if ! docker info &> /dev/null; then
        error_exit "Docker daemon is not running or not accessible. Please start Docker." $EXIT_DOCKER_ERROR
    fi
}

# Determine project directory:
# 1. Use first argument if provided and is a directory
# 2. Use current working directory if it contains .devcontainer
# 3. Use script's directory as fallback
determine_project_dir() {
    local potential_path="$1"
    
    if [ -n "$potential_path" ]; then
        validate_project_path "$potential_path"
    elif [ -f ".devcontainer/devcontainer.json" ] || [ -f ".devcontainer.json" ]; then
        PROJECT_DIR="$(pwd)"
    else
        PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    fi
    
    # Final validation
    if [ ! -d "$PROJECT_DIR" ]; then
        error_exit "Determined project directory '$PROJECT_DIR' is not valid." $EXIT_CONFIG_ERROR
    fi
}

# Parse and validate arguments
COMMAND="${1:-help}"

# Handle special completion command
if [ "$COMMAND" = "completion" ]; then
    _generate_completion() {
        local shell="${2:-bash}"
        
        if [ "$shell" = "bash" ]; then
            cat << 'BASH_EOF'
#!/bin/bash

# Bash completion for dcutil
_dcutil_completion() {
    local cur prev words cword
    _init_completion || return

    local commands="up down enter build clean status logs run init install-opencode help completion"
    local init_commands="fast wizard --fast --wizard --help -h"
    
    case "${prev}" in
        dcutil)
            COMPREPLY=($(compgen -W "${commands}" -- "${cur}"))
            return
            ;;
        init)
            COMPREPLY=($(compgen -W "${init_commands}" -- "${cur}"))
            return
            ;;
        run)
            if [[ ${cword} -eq 2 ]]; then
                local paths=()
                for dir in */; do
                    if [[ -d "${dir}" && ( -f "${dir}.devcontainer/devcontainer.json" || -f "${dir}.devcontainer.json" ) ]]; then
                        paths+=("${dir%/}")
                    fi
                done
                if [[ -f ".devcontainer/devcontainer.json" || -f ".devcontainer.json" ]]; then
                    paths+=(".")
                fi
                paths+=($(compgen -d -- "${cur}"))
                COMPREPLY=($(compgen -W "${paths[*]}" -- "${cur}"))
            else
                local common_commands="bash sh npm node python pip go make cmake cargo rustc"
                COMPREPLY=($(compgen -W "${common_commands}" -- "${cur}"))
            fi
            return
            ;;
        *)
            if [[ "${prev}" != "help" && "${prev}" != "--help" && "${prev}" != "-h" ]]; then
                local paths=()
                for dir in */; do
                    if [[ -d "${dir}" && ( -f "${dir}.devcontainer/devcontainer.json" || -f "${dir}.devcontainer.json" ) ]]; then
                        paths+=("${dir%/}")
                    fi
                done
                if [[ -f ".devcontainer/devcontainer.json" || -f ".devcontainer.json" ]]; then
                    paths+=(".")
                fi
                paths+=($(compgen -d -- "${cur}"))
                COMPREPLY=($(compgen -W "${paths[*]}" -- "${cur}"))
            fi
            return
            ;;
    esac

    if [[ "${cur}" == -* ]]; then
        local options="--help -h"
        COMPREPLY=($(compgen -W "${options}" -- "${cur}"))
        return
    fi
}

complete -F _dcutil_completion dcutil
BASH_EOF
        elif [ "$shell" = "zsh" ]; then
            cat << 'ZSH_EOF'
#compdef dcutil

_dcutil() {
    local -a commands
    commands=(
        'up:Start the devcontainer'
        'down:Stop the devcontainer'
        'enter:Enter the container shell'
        'build:Build the devcontainer image'
        'clean:Remove the devcontainer and clean up'
        'status:Show container status'
        'logs:Show container logs'
        'run:Run a command in the container'
        'init:Initialize a devcontainer'
        'install-opencode:Install opencode inside the devcontainer'
        'help:Show help message'
        'completion:Generate completion script'
    )

    local -a init_commands
    init_commands=(
        'fast:Create basic Ubuntu container automatically'
        'wizard:Interactive setup'
        '--fast:Create basic Ubuntu container automatically'
        '--wizard:Interactive setup'
        '--help:Show init help'
        '-h:Show init help'
    )

    local -a common_container_commands
    common_container_commands=(
        'bash:Bash shell'
        'sh:POSIX shell'
        'npm:Node Package Manager'
        'node:Node.js runtime'
        'python:Python interpreter'
        'pip:Python package installer'
        'go:Go compiler'
        'make:Make build tool'
        'cmake:CMake build system'
        'cargo:Rust package manager'
        'rustc:Rust compiler'
    )

    local context state state_descr line
    typeset -A opt_args

    _arguments -C \
        '1: :->command' \
        '*: :->args' \
        && return 0

    case $state in
        command)
            _describe 'command' commands
            ;;
        args)
            case $line[1] in
                init)
                    if [[ $line[2] == --* || $line[2] == -h ]]; then
                        _describe 'init option' init_commands
                    else
                        _describe 'init mode' init_commands
                    fi
                    ;;
                run)
                    if [[ ${#line} -eq 2 ]]; then
                        _alternative \
                            'paths:project path:_directories -S /' \
                            'devcontainer-projects:devcontainer projects:_dcutil_devcontainer_projects'
                    else
                        _describe 'container command' common_container_commands
                    fi
                    ;;
                *)
                    _alternative \
                        'paths:project path:_directories -S /' \
                        'devcontainer-projects:devcontainer projects:_dcutil_devcontainer_projects'
                    ;;
            esac
            ;;
    esac
}

_dcutil_devcontainer_projects() {
    local -a projects
    for dir in */; do
        if [[ -d "$dir" && ( -f "$dir.devcontainer/devcontainer.json" || -f "$dir.devcontainer.json" ) ]]; then
            projects+=("${dir%/}")
        fi
    done
    if [[ -f ".devcontainer/devcontainer.json" || -f ".devcontainer.json" ]]; then
        projects+=(".")
    fi
    _describe 'devcontainer projects' projects
}

_dcutil "$@"
ZSH_EOF
        else
            echo "Supported shells: bash, zsh" >&2
            exit 1
        fi
    }
    
    _generate_completion "$@"
    exit $EXIT_SUCCESS
fi

validate_command "$COMMAND"

# Handle special case for run command (project path can be second arg)
if [ "$COMMAND" = "run" ] && [ -n "$2" ] && [ -d "$2" ]; then
    determine_project_dir "$2"
    shift 2  # Remove command and project path
else
    determine_project_dir "$2"
    shift 1  # Remove command only
fi

# Helper functions
print_usage() {
    echo "Usage: dcutil <command> [project_path] [options]"
    echo ""
    echo "Commands:"
    echo "  up          Start the devcontainer"
    echo "  down        Stop the devcontainer"
    echo "  enter       Enter the container shell"
    echo "  build       Build the devcontainer image"
    echo "  clean       Remove the devcontainer and clean up"
    echo "  status      Show container status"
    echo "  logs        Show container logs"
    echo "  run <cmd>   Run a command in the container"
    echo "  init        Initialize a devcontainer (fast or wizard)"
    echo "  install-opencode Install opencode inside the devcontainer"
    echo "  completion  Generate completion script for bash/zsh"
    echo "  help        Show this help message"
    echo ""
    echo "Project path detection:"
    echo "  - If provided as second argument, uses that directory"
    echo "  - If current directory has .devcontainer/, uses current directory"
    echo "  - Otherwise uses script's directory"
}

# Safe execution functions
safe_devcontainer_command() {
    local cmd="$1"
    shift
    
    if ! check_devcontainer_cli; then
        return $EXIT_DEP_NOT_FOUND
    fi
    
    if ! check_docker_daemon; then
        return $EXIT_DOCKER_ERROR
    fi
    
    if ! devcontainer "$cmd" --workspace-folder "$PROJECT_DIR" "$@" 2>/dev/null; then
        error_exit "Devcontainer command failed: devcontainer $cmd $*" $EXIT_DEVCONTAINER_ERROR
    fi
}

# Change to project directory
info "Using project directory: $PROJECT_DIR"
cd "$PROJECT_DIR" || error_exit "Failed to change to project directory: $PROJECT_DIR" $EXIT_PERMISSION_ERROR

case "$COMMAND" in
    "up")
        info "Starting devcontainer setup..."
        safe_devcontainer_command "up"
        success "Devcontainer started successfully"
        ;;
    
    "down")
        info "Stopping devcontainer..."
        safe_devcontainer_command "down"
        success "Devcontainer stopped"
        ;;
    
    "enter")
        info "Entering container..."
        check_devcontainer_cli
        check_docker_daemon
        
        # Check if container is running, start it if needed
        if ! devcontainer ps --workspace-folder . 2>/dev/null | grep -q "Running"; then
            warning "Container is not running. Starting it..."
            if ! devcontainer up --workspace-folder . 2>/dev/null; then
                error_exit "Failed to start devcontainer" $EXIT_DEVCONTAINER_ERROR
            fi
        fi
        
        if ! devcontainer exec --workspace-folder . /bin/bash; then
            error_exit "Failed to enter container" $EXIT_DEVCONTAINER_ERROR
        fi
        ;;
    
    "build")
        info "Building devcontainer image..."
        safe_devcontainer_command "build"
        success "Build completed"
        ;;
    
    "clean")
        info "Cleaning up devcontainer..."
        check_devcontainer_cli
        check_docker_daemon
        
        # Stop container first (ignore if not running)
        devcontainer down --workspace-folder . 2>/dev/null || true
        
        # Delete container
        if ! devcontainer delete --workspace-folder . --force 2>/dev/null; then
            warning "Failed to delete devcontainer (may not exist)"
        fi
        success "Cleanup completed"
        ;;
    
    "status")
        info "Checking container status..."
        safe_devcontainer_command "ps"
        ;;
    
    "logs")
        info "Showing container logs..."
        safe_devcontainer_command "logs"
        ;;
    
    "run")
        validate_run_command "$@"
        info "Running command in container: $*"
        check_devcontainer_cli
        check_docker_daemon
        
        if ! devcontainer exec --workspace-folder "$PROJECT_DIR" "$@"; then
            error_exit "Failed to run command in container" $EXIT_DEVCONTAINER_ERROR
        fi
        ;;
    
    "install-opencode")
        info "Installing opencode inside devcontainer..."
        check_devcontainer_cli
        check_docker_daemon
        
        # Check if container is running
        if ! devcontainer ps --workspace-folder . 2>/dev/null | grep -q "Running"; then
            warning "Container is not running. Starting it first..."
            if ! devcontainer up --workspace-folder . 2>/dev/null; then
                error_exit "Failed to start devcontainer for opencode installation" $EXIT_DEVCONTAINER_ERROR
            fi
        fi
        
        info "Installing opencode..."
        if devcontainer exec --workspace-folder . /bin/bash -c "
            curl -fsSL https://opencode.ai/install | bash
        " 2>/dev/null; then
            success "Opencode installed successfully in devcontainer"
        else
            error_exit "Failed to install opencode" $EXIT_DEVCONTAINER_ERROR
        fi
        ;;
    
    "init")
        check_devcontainer_cli
        
        # Check if devcontainer already exists
        if [ -f ".devcontainer/devcontainer.json" ] || [ -f ".devcontainer.json" ]; then
            error_exit "Devcontainer configuration already exists. Use 'dcutil clean' first to remove existing configuration" $EXIT_CONFIG_ERROR
        fi
        
        # Parse init options
        INIT_MODE="${2:-wizard}"
        validate_init_mode "$INIT_MODE"
        
        case "$INIT_MODE" in
            "--fast"|"fast")
                info "Creating fast devcontainer configuration..."
                
                # Create .devcontainer directory
                if ! mkdir -p .devcontainer 2>/dev/null; then
                    error_exit "Failed to create .devcontainer directory" $EXIT_PERMISSION_ERROR
                fi
                
                # Create basic devcontainer.json
                if ! cat > .devcontainer/devcontainer.json << 'EOF'
{
    "name": "Basic Dev Container",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-vscode.vscode-json"
            ]
        }
    },
    "postCreateCommand": "apt-get update && apt-get install -y curl git"
}
EOF
                then
                    error_exit "Failed to create devcontainer.json file" $EXIT_PERMISSION_ERROR
                fi
                
                success "Fast devcontainer configuration created"
                info "Run 'dcutil up' to start the container"
                ;;
                
            "--wizard"|"wizard"|"")
                info "Devcontainer Initialization Wizard"
                echo ""
                
                # Get project type
                echo -e "${YELLOW}ðŸ“‹ Choose project type:${NC}"
                echo "1) Basic (Ubuntu + common tools)"
                echo "2) Node.js"
                echo "3) Python"
                echo "4) Go"
                echo "5) Custom image"
                echo ""
                read -r -p "Enter choice [1-5]: " project_choice
                
                # Validate project choice
                if [[ ! "$project_choice" =~ ^[1-5]$ ]]; then
                    error_exit "Invalid choice. Please enter a number between 1-5." $EXIT_INVALID_ARGS
                fi
                
                # Get container name
                read -r -p "Container name [My Project]: " container_name
                container_name=${container_name:-"My Project"}
                
                if ! mkdir -p .devcontainer 2>/dev/null; then
                    error_exit "Failed to create .devcontainer directory" $EXIT_PERMISSION_ERROR
                fi
                
                case "$project_choice" in
                    "1")
                        cat > .devcontainer/devcontainer.json << EOF
{
    "name": "$container_name",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-vscode.vscode-json",
                "ms-vscode.vscode-git"
            ]
        }
    },
    "postCreateCommand": "apt-get update && apt-get install -y curl git vim nano"
}
EOF
                        ;;
                    "2")
                        cat > .devcontainer/devcontainer.json << EOF
{
    "name": "$container_name",
    "image": "mcr.microsoft.com/devcontainers/javascript-node:18",
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-vscode.vscode-json",
                "esbenp.prettier-vscode"
            ]
        }
    },
    "postCreateCommand": "npm install"
}
EOF
                        ;;
                    "3")
                        cat > .devcontainer/devcontainer.json << EOF
{
    "name": "$container_name",
    "image": "mcr.microsoft.com/devcontainers/python:3.10",
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-python.python",
                "ms-python.vscode-pylance"
            ]
        }
    },
    "postCreateCommand": "pip install -r requirements.txt"
}
EOF
                        ;;
                    "4")
                        cat > .devcontainer/devcontainer.json << EOF
{
    "name": "$container_name",
    "image": "golang:1.21",
    "customizations": {
        "vscode": {
            "extensions": [
                "golang.go"
            ]
        }
    },
    "postCreateCommand": "go mod download"
}
EOF
                        ;;
                    "5")
                        read -r -p "Enter Docker image name: " custom_image
                        if [ -z "$custom_image" ]; then
                            error_exit "Docker image name cannot be empty" $EXIT_INVALID_ARGS
                        fi
                        if ! cat > .devcontainer/devcontainer.json << EOF
{
    "name": "$container_name",
    "image": "$custom_image"
}
EOF
                        then
                            error_exit "Failed to create devcontainer.json file" $EXIT_PERMISSION_ERROR
                        fi
                        ;;
                    *)
                        error_exit "Invalid choice" $EXIT_INVALID_ARGS
                        ;;
                esac
                
                success "Devcontainer configuration created"
                info "Run 'dcutil up' to start the container"
                ;;
                
            "--help"|"-h")
                echo "Usage: dcutil init [mode]"
                echo ""
                echo "Modes:"
                echo "  fast     Create basic Ubuntu container automatically"
                echo "  wizard   Interactive setup (default)"
                echo ""
                echo "Examples:"
                echo "  dcutil init          # Start wizard"
                echo "  dcutil init fast     # Quick basic setup"
                echo "  dcutil init --fast   # Quick basic setup"
                ;;
                
            *)
                echo -e "${RED}âŒ Unknown init mode: $INIT_MODE${NC}"
                echo "Use 'dcutil init --help' for usage information"
                exit 1
                ;;
        esac
        ;;
    
    "help"|"-h"|"--help")
        print_usage
        ;;
    
*)
                error_exit "Unknown command: $COMMAND" $EXIT_INVALID_ARGS
                ;;
esac

exit $EXIT_SUCCESS
