#!/bin/bash

# General purpose devcontainer utility script
# Provides various operations for managing development containers

set -e

# Determine project directory:
# 1. Use first argument if provided and is a directory
# 2. Use current working directory if it contains .devcontainer
# 3. Use script's directory as fallback
if [ -n "$2" ] && [ -d "$2" ]; then
    PROJECT_DIR="$(cd "$2" && pwd)"
elif [ -f ".devcontainer/devcontainer.json" ] || [ -f ".devcontainer.json" ]; then
    PROJECT_DIR="$(pwd)"
else
    PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
fi
COMMAND=${1:-"help"}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_usage() {
    echo "Usage: dcutil <command> [project_path] [options]"
    echo ""
    echo "Commands:"
    echo "  up          Start the devcontainer"
    echo "  down        Stop the devcontainer"
    echo "  enter       Enter the container shell"
    echo "  build       Build the devcontainer image"
    echo "  clean       Remove the devcontainer and clean up"
    echo "  status      Show container status"
    echo "  logs        Show container logs"
    echo "  run <cmd>   Run a command in the container"
    echo "  init        Initialize a devcontainer (fast or wizard)"
    echo "  install-opencode Install opencode inside the devcontainer"
    echo "  help        Show this help message"
    echo ""
    echo "Project path detection:"
    echo "  - If provided as second argument, uses that directory"
    echo "  - If current directory has .devcontainer/, uses current directory"
    echo "  - Otherwise uses script's directory"
}

check_devcontainer_cli() {
    if ! command -v devcontainer &> /dev/null; then
        echo -e "${RED}‚ùå devcontainer CLI not found. Please install it first:${NC}"
        echo "   npm install -g @devcontainers/cli"
        exit 1
    fi
}

# Change to project directory
echo -e "${BLUE}üìÅ Using project directory: $PROJECT_DIR${NC}"
cd "$PROJECT_DIR"

case "$COMMAND" in
    "up")
        echo -e "${BLUE}üê≥ Starting devcontainer setup...${NC}"
        check_devcontainer_cli
        devcontainer up --workspace-folder .
        echo -e "${GREEN}‚úÖ Devcontainer started successfully${NC}"
        ;;
    
    "down")
        echo -e "${YELLOW}üõë Stopping devcontainer...${NC}"
        check_devcontainer_cli
        devcontainer down --workspace-folder .
        echo -e "${GREEN}‚úÖ Devcontainer stopped${NC}"
        ;;
    
    "enter")
        echo -e "${BLUE}üîó Entering container...${NC}"
        check_devcontainer_cli
        
        # Check if container is running, start it if needed
        if ! devcontainer ps --workspace-folder . | grep -q "Running"; then
            echo -e "${YELLOW}‚ö†Ô∏è  Container is not running. Starting it...${NC}"
            devcontainer up --workspace-folder .
        fi
        
        devcontainer exec --workspace-folder . /bin/bash
        ;;
    
    "build")
        echo -e "${BLUE}üî® Building devcontainer image...${NC}"
        check_devcontainer_cli
        devcontainer build --workspace-folder .
        echo -e "${GREEN}‚úÖ Build completed${NC}"
        ;;
    
    "clean")
        echo -e "${YELLOW}üßπ Cleaning up devcontainer...${NC}"
        check_devcontainer_cli
        devcontainer down --workspace-folder .
        devcontainer delete --workspace-folder . --force
        echo -e "${GREEN}‚úÖ Cleanup completed${NC}"
        ;;
    
    "status")
        echo -e "${BLUE}üìä Checking container status...${NC}"
        check_devcontainer_cli
        devcontainer ps --workspace-folder .
        ;;
    
    "logs")
        echo -e "${BLUE}üìã Showing container logs...${NC}"
        check_devcontainer_cli
        devcontainer logs --workspace-folder .
        ;;
    
    "run")
        # Handle project path argument
        if [ -n "$2" ] && [ -d "$2" ]; then
            PROJECT_DIR="$2"
            shift 2
        else
            shift 1
        fi
        
        if [ $# -eq 0 ]; then
            echo -e "${RED}‚ùå Error: run command requires a command to execute${NC}"
            echo "Usage: dcutil run [project_path] <command>"
            exit 1
        fi
        echo -e "${BLUE}üöÄ Running command in container: $*${NC}"
        check_devcontainer_cli
        devcontainer exec --workspace-folder "$PROJECT_DIR" "$@"
        ;;
    
    "install-opencode")
        echo -e "${BLUE}üì¶ Installing opencode inside devcontainer...${NC}"
        check_devcontainer_cli
        
        # Check if container is running
        if ! devcontainer ps --workspace-folder . | grep -q "Running"; then
            echo -e "${YELLOW}‚ö†Ô∏è  Container is not running. Starting it first...${NC}"
            devcontainer up --workspace-folder .
        fi
        
        echo -e "${BLUE}üîß Installing opencode...${NC}"
        if devcontainer exec --workspace-folder . /bin/bash -c "
            curl -fsSL https://opencode.ai/install | bash
        "; then
            echo -e "${GREEN}‚úÖ Opencode installed successfully in devcontainer${NC}"
        else
            echo -e "${RED}‚ùå Failed to install opencode${NC}"
            exit 1
        fi
        ;;
    
    "init")
        check_devcontainer_cli
        
        # Check if devcontainer already exists
        if [ -f ".devcontainer/devcontainer.json" ] || [ -f ".devcontainer.json" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  Devcontainer configuration already exists${NC}"
            echo -e "${YELLOW}   Use 'dcutil clean' first to remove existing configuration${NC}"
            exit 1
        fi
        
        # Parse init options
        INIT_MODE=${2:-"wizard"}
        
        case "$INIT_MODE" in
            "--fast"|"fast")
                echo -e "${BLUE}üöÄ Creating fast devcontainer configuration...${NC}"
                
                # Create .devcontainer directory
                mkdir -p .devcontainer
                
                # Create basic devcontainer.json
                cat > .devcontainer/devcontainer.json << 'EOF'
{
    "name": "Basic Dev Container",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-vscode.vscode-json"
            ]
        }
    },
    "postCreateCommand": "apt-get update && apt-get install -y curl git"
}
EOF
                
                echo -e "${GREEN}‚úÖ Fast devcontainer configuration created${NC}"
                echo -e "${BLUE}üí° Run 'dcutil up' to start the container${NC}"
                ;;
                
            "--wizard"|"wizard"|"")
                echo -e "${BLUE}üßô Devcontainer Initialization Wizard${NC}"
                echo ""
                
                # Get project type
                echo -e "${YELLOW}üìã Choose project type:${NC}"
                echo "1) Basic (Ubuntu + common tools)"
                echo "2) Node.js"
                echo "3) Python"
                echo "4) Go"
                echo "5) Custom image"
                echo ""
                read -r -p "Enter choice [1-5]: " project_choice
                
                # Get container name
                read -r -p "Container name [My Project]: " container_name
                container_name=${container_name:-"My Project"}
                
                mkdir -p .devcontainer
                
                case "$project_choice" in
                    "1")
                        cat > .devcontainer/devcontainer.json << EOF
{
    "name": "$container_name",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-vscode.vscode-json",
                "ms-vscode.vscode-git"
            ]
        }
    },
    "postCreateCommand": "apt-get update && apt-get install -y curl git vim nano"
}
EOF
                        ;;
                    "2")
                        cat > .devcontainer/devcontainer.json << EOF
{
    "name": "$container_name",
    "image": "mcr.microsoft.com/devcontainers/javascript-node:18",
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-vscode.vscode-json",
                "esbenp.prettier-vscode"
            ]
        }
    },
    "postCreateCommand": "npm install"
}
EOF
                        ;;
                    "3")
                        cat > .devcontainer/devcontainer.json << EOF
{
    "name": "$container_name",
    "image": "mcr.microsoft.com/devcontainers/python:3.10",
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-python.python",
                "ms-python.vscode-pylance"
            ]
        }
    },
    "postCreateCommand": "pip install -r requirements.txt"
}
EOF
                        ;;
                    "4")
                        cat > .devcontainer/devcontainer.json << EOF
{
    "name": "$container_name",
    "image": "golang:1.21",
    "customizations": {
        "vscode": {
            "extensions": [
                "golang.go"
            ]
        }
    },
    "postCreateCommand": "go mod download"
}
EOF
                        ;;
                    "5")
                        read -r -p "Enter Docker image name: " custom_image
                        cat > .devcontainer/devcontainer.json << EOF
{
    "name": "$container_name",
    "image": "$custom_image"
}
EOF
                        ;;
                    *)
                        echo -e "${RED}‚ùå Invalid choice${NC}"
                        exit 1
                        ;;
                esac
                
                echo -e "${GREEN}‚úÖ Devcontainer configuration created${NC}"
                echo -e "${BLUE}üí° Run 'dcutil up' to start the container${NC}"
                ;;
                
            "--help"|"-h")
                echo "Usage: dcutil init [mode]"
                echo ""
                echo "Modes:"
                echo "  fast     Create basic Ubuntu container automatically"
                echo "  wizard   Interactive setup (default)"
                echo ""
                echo "Examples:"
                echo "  dcutil init          # Start wizard"
                echo "  dcutil init fast     # Quick basic setup"
                echo "  dcutil init --fast   # Quick basic setup"
                ;;
                
            *)
                echo -e "${RED}‚ùå Unknown init mode: $INIT_MODE${NC}"
                echo "Use 'dcutil init --help' for usage information"
                exit 1
                ;;
        esac
        ;;
    
    "help"|"-h"|"--help")
        print_usage
        ;;
    
    *)
        echo -e "${RED}‚ùå Unknown command: $COMMAND${NC}"
        echo ""
        print_usage
        exit 1
        ;;
esac
